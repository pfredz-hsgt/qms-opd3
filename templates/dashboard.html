<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QMS Analytics Dashboard</title>
    <!-- Local Bootstrap CSS -->
    <link rel="stylesheet" href="/static/vendor/bootstrap/css/bootstrap.min.css">
    <style>
        :root {
            --primary-navy: #1a237e;
            --secondary-blue: #0d47a1;
            --soft-blue: #e8eaf6;
            --accent-cyan: #00bcd4;
            --text-dark: #2c3e50;
            --off-white: #f8f9fa;
        }

        body {
            font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--off-white);
            color: var(--text-dark);
            overflow-x: hidden;
        }

        /* Sidebar Styles */
        .sidebar {
            width: 260px;
            background: linear-gradient(180deg, var(--primary-navy) 0%, var(--secondary-blue) 100%);
            color: white;
            min-height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            transition: all 0.3s;
            z-index: 1000;
        }

        .sidebar-brand {
            padding: 1.5rem;
            font-size: 1.5rem;
            font-weight: 700;
            color: white;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .sidebar-menu {
            padding: 1rem 0;
        }

        .nav-link {
            color: rgba(255, 255, 255, 0.8);
            padding: 0.8rem 1.5rem;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.2s;
            font-weight: 500;
        }

        .nav-link:hover,
        .nav-link.active {
            color: white;
            background: rgba(255, 255, 255, 0.1);
            border-left: 4px solid var(--accent-cyan);
        }

        .nav-link i {
            width: 20px;
            text-align: center;
        }

        /* Main Content */
        .main-content {
            margin-left: 260px;
            padding: 2rem;
            transition: all 0.3s;
        }

        /* Responsive */
        @media (max-width: 992px) {
            .sidebar {
                margin-left: -260px;
            }

            .sidebar.active {
                margin-left: 0;
            }

            .main-content {
                margin-left: 0;
            }
        }

        /* Cards */
        .stat-card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s;
            background: white;
            height: 100%;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
        }

        .icon-box {
            width: 48px;
            height: 48px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .bg-soft-blue {
            background-color: var(--soft-blue);
            color: var(--primary-navy);
        }

        .bg-soft-success {
            background-color: #e8f5e9;
            color: #2e7d32;
        }

        .bg-soft-info {
            background-color: #e0f7fa;
            color: #0097a7;
        }

        /* Tables */
        .table-custom {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            overflow: hidden;
        }

        .table-custom thead {
            background-color: var(--primary-navy);
            color: white;
        }

        .table-custom th {
            font-weight: 600;
            padding: 1rem;
            border: none;
        }

        .table-custom td {
            padding: 1rem;
            vertical-align: middle;
            border-bottom: 1px solid #eee;
        }

        .badge-counter {
            font-size: 0.9em;
            padding: 0.5em 0.8em;
            border-radius: 6px;
        }

        .counter-badge-pill {
            background-color: var(--soft-blue);
            color: var(--primary-navy);
            font-weight: 600;
            padding: 5px 12px;
            border-radius: 20px;
        }

        /* Controls */
        .filter-bar {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.02);
            margin-bottom: 2rem;
        }

        /* Chart */
        .chart-container {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            margin-bottom: 2rem;
            position: relative;
            height: 350px;
        }
    </style>
</head>

<body>

    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-brand">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16">
                <path
                    d="M6.5 2a.5.5 0 0 0 0 1H1v2h5.5l7 7.5V11a.5.5 0 0 0 1 0v-4a.5.5 0 0 0 1 0V2h-9zM1 1v1h5.5L7 2.5V1a1 1 0 0 0-1-1H2a1 1 0 0 0-1 1z" />
            </svg>
            QMS OPD 3.0
        </div>
        <div class="sidebar-menu">
            <a href="/" class="nav-link">
                <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path
                        d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6">
                    </path>
                </svg>
                Terminal
            </a>
            <a href="#" class="nav-link active">
                <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path
                        d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z">
                    </path>
                </svg>
                Dashboard
            </a>
            <a href="/display" target="_blank" class="nav-link">
                <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path
                        d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z">
                    </path>
                </svg>
                Open TV Display
            </a>
        </div>
        <div class="mt-auto p-3">
            <button class="btn btn-outline-light w-100 btn-sm opacity-50" onclick="confirmRestart()">
                ‚ö†Ô∏è Restart Server
            </button>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Mobile Toggle -->
        <button class="btn btn-outline-primary d-lg-none mb-3" onclick="toggleSidebar()">
            ‚ò∞ Menu
        </button>

        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2 class="fw-bold mb-1">Dashboard Overview</h2>
                <p class="text-muted">Real-time stats and call analytics</p>
            </div>
            <div class="d-flex gap-2">
                <button class="btn btn-light border" onclick="location.reload()">
                    ‚Üª Refresh
                </button>
                <div class="dropdown">
                    <button class="btn btn-primary" onclick="exportToExcel()">
                        üì• Export Report
                    </button>
                </div>
            </div>
        </div>

        <!-- Filter Bar -->
        <div class="filter-bar d-flex flex-wrap gap-3 align-items-end">
            <div>
                <label class="form-label text-muted small fw-bold text-uppercase">Date Filter</label>
                <input type="date" id="date-filter" class="form-control" onchange="loadDataForDate()">
            </div>
            <div class="flex-grow-1">
                <label class="form-label text-muted small fw-bold text-uppercase">Search Calling Number</label>
                <input type="text" id="number-search" class="form-control" placeholder="Type to filter..."
                    onkeyup="debouncedSearch()">
            </div>
            <div>
                <button class="btn btn-outline-primary" onclick="loadTodayData()">Today's Data</button>
                <button class="btn btn-outline-secondary" onclick="loadRecentData()">Show All Recent</button>
            </div>
        </div>



        <!-- Stats Cards -->
        <div class="row g-4 mb-4">
            <div class="col-md-4">
                <div class="stat-card p-4">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <p class="text-muted mb-1">Calls Today</p>
                            <h2 class="fw-bold mb-0" id="today-total">-</h2>
                        </div>
                        <div class="icon-box bg-soft-blue">
                            üìû
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stat-card p-4">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <p class="text-muted mb-1">Active Counters</p>
                            <h2 class="fw-bold mb-0" id="total-counters">-</h2>
                        </div>
                        <div class="icon-box bg-soft-success">
                            üè¢
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stat-card p-4">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <p class="text-muted mb-1">Filtered Results</p>
                            <h2 class="fw-bold mb-0" id="filtered-total">-</h2>
                        </div>
                        <div class="icon-box bg-soft-info">
                            üîç
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Left Column: Chart -->
            <div class="col-lg-8">
                <div class="chart-container">
                    <h5 class="fw-bold mb-3">Call Volume Statistics</h5>
                    <canvas id="callsChart"></canvas>
                </div>
                <h4 id="selected-date-header" class="text-primary fw-bold mb-4"></h4>
                <div class="table-custom">
                    <div class="p-4 border-bottom d-flex justify-content-between align-items-center">
                        <h5 class="fw-bold mb-0">Detailed Call Logs</h5>

                        <span class="badge bg-light text-dark border" id="table-count-badge">0 records</span>
                    </div>
                    <div class="table-responsive" id="table-content">
                        <!-- Table injected via JS -->

                        <div class="text-center p-5 text-muted">
                            <div class="spinner-border text-primary mb-2" role="status"></div>
                            <p>Loading data...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column: Counter Stats -->
            <div class="col-lg-4">
                <div class="bg-white rounded-4 shadow-sm p-4 h-100">
                    <h5 class="fw-bold mb-4">Counter Performance</h5>
                    <div id="counter-stats" class="d-flex flex-column gap-3">
                        <!-- Counter stats injected here -->
                        <div class="text-center p-3 text-muted">Loading...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="/static/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script src="/static/vendor/chartjs/chart.umd.min.js"></script>
    <script src="/static/vendor/sheetjs/xlsx.full.min.js"></script>

    <script>
        // State
        let currentData = [];
        let myChart = null;

        // Initialization
        document.addEventListener('DOMContentLoaded', function () {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('date-filter').value = today;

            loadTodayData();
            loadStats();
        });

        // Sidebar Toggle
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('active');
        }

        // --- Data Loading Functions ---

        async function loadTodayData() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('date-filter').value = today;
            await loadDataForDate();
        }

        async function loadRecentData() {
            document.getElementById('date-filter').value = '';
            document.getElementById('number-search').value = ''; // Clear search
            updateDateHeader('Recent Records (Last 500)');

            showLoading(true);
            try {
                const response = await fetch('/api/logs/recent?limit=500');
                const result = await response.json();
                if (result.status === 'success') {
                    processData(result.data);
                }
            } catch (error) {
                console.error(error);
            }
            showLoading(false);
        }

        async function loadDataForDate() {
            const selectedDate = document.getElementById('date-filter').value;
            // Clear search when changing date
            document.getElementById('number-search').value = '';

            if (!selectedDate) return loadRecentData();

            updateDateHeader(`Data for ${selectedDate}`);
            showLoading(true);
            try {
                const response = await fetch(`/api/logs/date/${selectedDate}`);
                const result = await response.json();
                if (result.status === 'success') {
                    processData(result.data);
                    updateChartWithHistory();
                }
            } catch (error) {
                console.error(error);
            }
            showLoading(false);
        }

        function updateDateHeader(text) {
            const el = document.getElementById('selected-date-header');
            if (el) el.textContent = text;
        }

        // Function to fetch last 5 days data for the chart
        async function updateChartWithHistory() {
            // We want to show Today and previous 4 days
            const labels = [];
            const dataPoints = [];
            const datesToFetch = [];

            for (let i = 4; i >= 0; i--) {
                const d = new Date();
                d.setDate(d.getDate() - i);
                const dateStr = d.toISOString().split('T')[0];
                datesToFetch.push(dateStr);
                labels.push(i === 0 ? 'Today' : dateStr.slice(5)); // Show MM-DD
            }

            // Fetch in parallel
            try {
                const promises = datesToFetch.map(date =>
                    fetch(`/api/logs/date/${date}`)
                        .then(res => res.json())
                        .then(res => res.data ? res.data.length : 0)
                        .catch(() => 0)
                );

                const results = await Promise.all(promises);

                renderChart(labels, results);

            } catch (e) {
                console.error("Failed to load chart history", e);
            }
        }

        async function loadStats() {
            try {
                const response = await fetch('/api/logs/stats');
                const result = await response.json();
                if (result.status === 'success') {
                    const stats = result.data.today || {};
                    document.getElementById('today-total').textContent = stats.total_calls || 0;
                    if (stats.counter_usage) {
                        document.getElementById('total-counters').textContent = Object.keys(stats.counter_usage).length;
                    }
                }
            } catch (error) { console.error(error); }
        }

        // --- Processing & Rendering ---

        function processData(data, updateGlobals = true) {
            if (updateGlobals) {
                currentData = data;
            }
            document.getElementById('filtered-total').textContent = data.length;
            document.getElementById('table-count-badge').textContent = `${data.length} records`;

            renderTable(data);
            renderCounterStats(data);
        }

        function renderTable(data) {
            const container = document.getElementById('table-content');
            if (!data || data.length === 0) {
                container.innerHTML = `<div class="text-center p-5 text-muted">üì≠ No records found</div>`;
                return;
            }

            let html = `
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>Time</th>
                            <th>Number</th>
                            <th>Counter</th>
                            <th>Date</th>
                            <th>Day</th>
                        </tr>
                    </thead>
                    <tbody>`;

            data.forEach(row => {
                html += `
                    <tr>
                        <td class="fw-bold text-primary">${row.time}</td>
                        <td><span class="badge bg-light text-dark border  fs-6">${row.number}</span></td>
                        <td><span class="counter-badge-pill">Kaunter ${row.counter}</span></td>
                        <td class="text-muted small">${row.date}</td>
                        <td class="text-muted small">${row.day_of_week}</td>
                    </tr>
                `;
            });

            html += `</tbody></table>`;
            container.innerHTML = html;
        }

        function renderCounterStats(data) {
            const container = document.getElementById('counter-stats');
            const counts = {};
            data.forEach(d => counts[d.counter] = (counts[d.counter] || 0) + 1);

            if (Object.keys(counts).length === 0) {
                container.innerHTML = `<p class="text-muted">No active counters</p>`;
                return;
            }

            const sorted = Object.entries(counts).sort(([, a], [, b]) => b - a);

            container.innerHTML = sorted.map(([counter, count], index) => {
                const percent = Math.round((count / data.length) * 100);
                return `
                    <div>
                        <div class="d-flex justify-content-between mb-1">
                            <span class="fw-bold">Kaunter ${counter}</span>
                            <span class="badge bg-primary rounded-pill">${count}</span>
                        </div>
                        <div class="progress" style="height: 6px;">
                            <div class="progress-bar" role="progressbar" style="width: ${percent}%"></div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderChart(labels, data) {
            const ctx = document.getElementById('callsChart');

            if (myChart) {
                myChart.destroy();
            }

            myChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Calls Processed',
                        data: data,
                        backgroundColor: '#1a237e',
                        borderRadius: 5,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true, grid: { borderDash: [2, 4] } },
                        x: { grid: { display: false } }
                    }
                }
            });
        }

        // --- Export ---

        function exportToExcel() {
            if (!currentData || currentData.length === 0) {
                alert("No data to export!");
                return;
            }

            const ws = XLSX.utils.json_to_sheet(currentData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Call Logs");

            const filename = `Call_Logs_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, filename);
        }

        function showLoading(isLoading) {
            const el = document.getElementById('table-content');
            if (isLoading) {
                el.innerHTML = `
                    <div class="text-center p-5 text-muted">
                        <div class="spinner-border text-primary mb-2" role="status"></div>
                        <p>Loading...</p>
                    </div>`;
            }
        }

        function confirmRestart() {
            if (confirm("Are you sure you want to RESTART the server logic? Only do this if the display is stuck.")) {
                fetch('/api/restart', { method: 'POST' })
                    .then(res => res.json())
                    .then(data => showToast('Server restarting...', 'bg-danger'))
                    .catch(err => showToast('Failed to restart', 'bg-danger'));
            }
        }

        // --- Search & Debounce ---

        let searchTimeout;

        function debouncedSearch() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                const query = document.getElementById('number-search').value.trim().toLowerCase();
                filterAndRender(query);
            }, 300);
        }

        function filterAndRender(query) {
            if (!query) {
                // If query is empty, show all current data
                processData(currentData, false); // false to skip resetting currentData
                return;
            }

            const filtered = currentData.filter(row =>
                (row.number && row.number.toString().toLowerCase().includes(query))
            );

            // Update UI with filtered subset
            document.getElementById('filtered-total').textContent = filtered.length;
            document.getElementById('table-count-badge').textContent = `${filtered.length} records (Filtered)`;
            renderTable(filtered);
            // Optionally update counter stats based on filtered view or keep global? Usually filtered view.
            renderCounterStats(filtered);
        }

    </script>
</body>

</html>